@startuml "main"
  package "edu.hust" {
    class Main {
      +{static} main(String) : void
    }
  }

  package "edu.hust.buffer" {
    class Buffer {
      -data : byte
      -width : int
      -height : int
      -gainMap : Buffer
      +getData() : byte
      +setData(byte) : void
      +getWidth() : int
      +getHeight() : int
      +getGainMap() : Buffer
      +setGainMap(Buffer) : void
      +hasGainMap() : boolean
      +createGainmap() : Buffer
    }
  }

  package "edu.hust.pipeline" {
    interface ImageProcessor {
      ~run(Buffer, Buffer, PipelineOption) : Buffer
    }
    class Pipeline {
      -rootProcessor : ImageProcessor
      -nameMapping : String
      +run(Buffer, Buffer, PipelineOption) : Buffer
      +getNameMapping() : String
    }
    class Builder {
      -stepDefinitions : StepDef
      +add(ImageProcessorType, ImagePluginType) : Builder
      +add(String, ImageProcessorType, ImagePluginType) : Builder
      +build() : Pipeline
      -resolvePlugins(StepDef) : ImagePlugin
    }
    class StepDef {
      ~name : String
      ~pType : ImageProcessorType
      ~plType : ImagePluginType
    }
    class PipelineOption {
      -stepData : Integer
      -nameMapping : String
      -activeIndex : int
      -configCursor : int
      +step() : StepConfig
      +step(int) : StepConfig
      +step(String) : StepConfig
      +setActiveIndex(int) : void
      +setNames(String) : void
      +get(String) : Object
      +getActiveOption() : String
      +toString() : String
    }
    class StepConfig {
      -index : int
      +set(String, Object) : StepConfig
      +step() : StepConfig
    }
    class SingleImageProcessor {
      -name : String
      -implementation : ImageProcessor
      -stepIndex : int
      +run(Buffer, Buffer, PipelineOption) : Buffer
      +toString() : String
    }
  }

  package "edu.hust.plugin" {
    abstract class BasePlugin {
      -processors : ImageProcessorType
      #bind(ImageProcessorType, ImageProcessor) : void
      +getProcessor(ImageProcessorType) : ImageProcessor
    }
    class GlobalPluginRegistry {
      -plugins : ImagePlugin
      +{static} getInstance() : GlobalPluginRegistry
      +register(ImagePlugin) : void
      +findProviders(ImageProcessorType) : ImagePlugin
    }
    class Holder {
      -{static} INSTANCE : GlobalPluginRegistry
    }
    interface ImagePlugin {
      ~getName() : String
      ~getProcessor(ImageProcessorType) : ImageProcessor
      ~supports(ImageProcessorType) : boolean
    }
  }

  package "edu.hust.type" {
    enum ImagePluginType {
      OPENCV
      OPENCL
      VULKAN
      SOFTWARE
      ANY
    }
    enum ImageProcessorType {
      RESIZE
      CROP
      ROTATE
      FLIP
      WATERMARK
      GAUSSIAN_BLUR
      FILTER
    }
  }

  package "edu.hust.plugin.impl" {
    class OpenCLPlugin {
      +getName() : String
      -resize(Buffer, Buffer, PipelineOption) : Buffer
      -crop(Buffer, Buffer, PipelineOption) : Buffer
      -rotate(Buffer, Buffer, PipelineOption) : Buffer
    }
    class OpenCVPlugin {
      +getName() : String
      -resize(Buffer, Buffer, PipelineOption) : Buffer
      -crop(Buffer, Buffer, PipelineOption) : Buffer
      -filter(Buffer, Buffer, PipelineOption) : Buffer
    }
    class SoftwarePlugin {
      +getName() : String
      -resize(Buffer, Buffer, PipelineOption) : Buffer
      -filter(Buffer, Buffer, PipelineOption) : Buffer
    }
    class VulkanPlugin {
      +getName() : String
      -resize(Buffer, Buffer, PipelineOption) : Buffer
      -filter(Buffer, Buffer, PipelineOption) : Buffer
    }
  }

  package "edu.hust.pipeline.composite" {
    class GroupProcessor {
      -chain : ImageProcessor
      +run(Buffer, Buffer, PipelineOption) : Buffer
    }
    class NativeFlattenProcessor {
      -chain : ImageProcessor
      +run(Buffer, Buffer, PipelineOption) : Buffer
    }
  }

  package "edu.hust.pipeline.decorator" {
    class FailoverDecorator {
      -candidates : ImageProcessor
      +run(Buffer, Buffer, PipelineOption) : Buffer
    }
    class HdrDecorator {
      -delegate : ImageProcessor
      +run(Buffer, Buffer, PipelineOption) : Buffer
    }
  }


' Relationships
BasePlugin ..> ImageProcessor
BasePlugin <|-- OpenCLPlugin
BasePlugin <|-- OpenCVPlugin
BasePlugin <|-- SoftwarePlugin
BasePlugin <|-- VulkanPlugin
BasePlugin o-- ImageProcessorType
Builder ..> ImagePlugin
Builder ..> ImagePluginType
Builder ..> ImageProcessorType
Builder ..> Pipeline
Builder o-- StepDef
FailoverDecorator ..> Buffer
FailoverDecorator ..> PipelineOption
FailoverDecorator o-- ImageProcessor
GlobalPluginRegistry ..> ImageProcessorType
GlobalPluginRegistry o-- ImagePlugin
GroupProcessor ..> Buffer
GroupProcessor ..> PipelineOption
GroupProcessor o-- ImageProcessor
HdrDecorator --> ImageProcessor
HdrDecorator ..> Buffer
HdrDecorator ..> PipelineOption
Holder --> GlobalPluginRegistry
ImagePlugin ..> ImageProcessor
ImagePlugin ..> ImageProcessorType
ImagePlugin <|.. BasePlugin
ImageProcessor ..> Buffer
ImageProcessor ..> PipelineOption
ImageProcessor <|.. FailoverDecorator
ImageProcessor <|.. GroupProcessor
ImageProcessor <|.. HdrDecorator
ImageProcessor <|.. NativeFlattenProcessor
ImageProcessor <|.. Pipeline
ImageProcessor <|.. SingleImageProcessor
NativeFlattenProcessor ..> Buffer
NativeFlattenProcessor ..> PipelineOption
NativeFlattenProcessor o-- ImageProcessor
OpenCLPlugin ..> Buffer
OpenCLPlugin ..> PipelineOption
OpenCVPlugin ..> Buffer
OpenCVPlugin ..> PipelineOption
Pipeline --> ImageProcessor
Pipeline ..> Buffer
Pipeline ..> PipelineOption
PipelineOption ..> StepConfig
SingleImageProcessor --> ImageProcessor
SingleImageProcessor ..> Buffer
SingleImageProcessor ..> PipelineOption
SoftwarePlugin ..> Buffer
SoftwarePlugin ..> PipelineOption
StepDef --> ImagePluginType
StepDef --> ImageProcessorType
VulkanPlugin ..> Buffer
VulkanPlugin ..> PipelineOption
@enduml